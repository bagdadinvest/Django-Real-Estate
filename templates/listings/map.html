{% extends 'base.html' %}
{% load static %}

{% block content %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
>

<style>
  #map {
    width: 100%;
    height: 70vh;
    border-radius: 6px;
  }
  .popup-card {
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  .popup-card img {
    width: 90px;
    height: 70px;
    object-fit: cover;
    border-radius: 4px;
  }
  .popup-card .meta {
    line-height: 1.2;
  }
  .popup-card .title { font-weight: 600; }
  .popup-card .price { color: #1a7f37; font-weight: 600; }
  .leaflet-container a { text-decoration: none; }
  .map-toolbar { margin: 15px 0; }
  .map-toolbar .btn { margin-right: 8px; }
  .map-wrapper { margin: 20px 0; }
  .legend { font-size: 12px; color: #555; margin-top: 8px; }
  .legend code { background: #f3f3f3; padding: 2px 4px; border-radius: 3px; }
  @media (max-width: 576px) { #map { height: 60vh; } }
  @media (min-width: 1200px) { #map { height: 75vh; } }
</style>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h2>Map of Listings</h2>
      <p class="text-muted">Interactive map with clustered listings. Click a marker to see details.</p>

      <div class="map-toolbar">
        <button id="fit-btn" class="btn btn-primary btn-sm">Fit to Results</button>
        <a href="{% url 'listings:listings' %}" class="btn btn-default btn-sm">Back to Listings</a>
        <div class="legend">Data endpoint: <code>/listings/map-data/</code>. Update filters server-side as needed.</div>
      </div>

      <div class="map-wrapper">
        <div id="map"></div>
      </div>
    </div>
  </div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  (function () {
    var map = L.map('map');

    // OSM tiles (you may swap to another provider)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var markers = L.markerClusterGroup();
    var bounds = L.latLngBounds();

    function fmtCurrency(n) {
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
      } catch (e) {
        return n;
      }
    }

    function featureToMarker(f) {
      var coords = f.geometry.coordinates; // [lng, lat]
      var latlng = L.latLng(coords[1], coords[0]);
      bounds.extend(latlng);

      var p = f.properties || {};
      var html = '<div class="popup-card">';
      if (p.photo_url) {
        html += '<img src="' + p.photo_url + '" alt="photo">';
      }
      html += '<div class="meta">';
      html += '<div class="title">' + (p.title || 'Listing') + '</div>';
      if (p.price) { html += '<div class="price">' + fmtCurrency(p.price) + '</div>'; }
      var addrLine = [p.address, p.city, p.state].filter(Boolean).join(', ');
      if (addrLine) { html += '<div class="addr">' + addrLine + '</div>'; }
      if (p.bedrooms || p.bathrooms) {
        html += '<div class="specs">' + (p.bedrooms || '-') + ' bd Â· ' + (p.bathrooms || '-') + ' ba</div>';
      }
      if (p.url) { html += '<div style="margin-top:6px"><a class="btn btn-primary btn-xs" href="' + p.url + '">View details</a></div>'; }
      html += '</div></div>';

      return L.marker(latlng).bindPopup(html);
    }

    fetch('{% url 'listings:map_data' %}')
      .then(function (r) { return r.json(); })
      .then(function (geojson) {
        console.log('Received map data:', geojson);
        if (!geojson || !geojson.features) {
          console.warn('No features found in map data');
          return;
        }
        console.log('Number of features:', geojson.features.length);
        geojson.features.forEach(function (f) {
          console.log('Processing feature:', f);
          markers.addLayer(featureToMarker(f));
        });
        map.addLayer(markers);
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        } else {
          console.warn('No valid bounds - defaulting to world view');
          map.setView([0, 0], 2);
        }
      })
      .catch(function (e) {
        console.error('Failed to load map data', e);
        map.setView([0, 0], 2);
      });

    document.getElementById('fit-btn').addEventListener('click', function () {
      if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
      }
    });
  })();
</script>
{% endblock %}

